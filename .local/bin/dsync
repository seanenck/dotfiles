#!/bin/sh
DOCS="$HOME/Documents"
NOW_CMD="now"
SCREEN_NAME="dsync-daemon"
MANAGE_CMD="manage"
RUN_CMD="run"
LOCAL="$HOME/.local/voidedtech"
LOGS="$LOCAL/dsync"
ERROR="ERROR"

if [ "$(uname)" != "Darwin" ]; then
  echo "unsuitable os found"
  exit 1
fi

mkdir -p "$LOGS"
CMD="$1"
if [ -z "$1" ]; then
  CMD="$MANAGE_CMD"
fi

_sync() {
  if ! rclone --config "$HOME/Env/secrets/sync/rclone.conf" sync --no-update-dir-modtime --no-update-modtime --checksum core:"/home/enck/Documents/" "$DOCS" 2>&1; then
    echo "[$ERROR] failed to sync"
  fi
}

_run() {
  while : ; do
    LOGFILE="$LOGS/$(date +%Y-%m-%d-%p)"
    if [ -e "$LOGFILE" ]; then
      sleep 600
      continue
    fi
    if ! ping -c 1 -W 1 core.voidedtech.com 2>&1 > /dev/null; then
      echo "host offline"
      sleep 600
      continue
    fi
    caffeinate -s "$0" "$NOW_CMD" >> "$LOGFILE"
  done
}

case "$CMD" in
  "$NOW_CMD")
    _sync
    ;;
  "$MANAGE_CMD")
    STARTS=0
    find "$LOGS" -mtime +10 -delete
    while : ; do
      if screen -list 2>/dev/null | grep -q "$SCREEN_NAME"; then
        break
      fi
      STARTS=$((STARTS+1))
      if [ "$STARTS" -gt 4 ]; then
        echo "unable to start daemon..."
        break
      fi
      screen -d -m -S "$SCREEN_NAME" "$0" "$RUN_CMD"
      sleep 0.25
    done
    for FILE in $(find "$LOGS" -type f -mtime -3); do
      if grep -q "$ERROR" "$FILE"; then
        echo "found error in: $FILE"
      fi
    done
    ;;
  "$RUN_CMD")
    _run
    ;;
  *)
    echo "unknown command: $CMD"
    exit 1
    ;;
esac
