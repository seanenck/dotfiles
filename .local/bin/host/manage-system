#!/bin/sh
VERSION="39"
UPDATE="update-toolbox"
BUILD="build-toolbox"
GOTOOLS="go-tooling"
ALL="update-all"
CMDS="$UPDATE $BUILD $ALL $GOTOOLS"
if [ -z "$1" ]; then
  echo "command required"
  exit 1
fi

_toolboxes() {
  for TB in $(toolbox list -c | tail -n +2 | awk '{print $2}'); do
    echo "updating: $TB"
    if ! toolbox run -c "$TB" sudo dnf update -y; then
      echo "update failed"
      exit 1
    fi
  done 
}

_gotooling() {
  if ! toolbox run -c "go" fish -c "gotooling"; then
    echo "failed to update go tooling"
    exit 1
  fi
}

case "$1" in
  "$BUILD")
    for CONTAINER in go ffmpeg; do
      if toolbox list -c | tail -n +2 | awk '{print $2}' | grep -q "^$CONTAINER\$"; then
        echo "$CONTAINER exists..."
        continue
      fi
      if ! toolbox create --image "ghcr.io/enckse/fedora-toolbox-$CONTAINER:$VERSION-master" "$CONTAINER"; then
        echo "failed"
        exit 1
      fi
    done
    ;;
  "$UPDATE")
    _toolboxes
    ;;
  "$GOTOOLS")
    _gotooling
    ;;
  "$ALL")
    if ! neovim-plugins; then
      exit 1
    fi
    _toolboxes
    _gotooling
    ;;
  "fish")
    cat << EOF
complete -c manage-system -f
complete -c manage-system -n "not __fish_seen_subcommand_from $CMDS" -a "$CMDS"
EOF
    ;;
  *)
    echo "unknown command: $1"
    exit 1
    ;;
esac

