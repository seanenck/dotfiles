#!/bin/sh
SOURCES="$HOME/Env/dotfiles/src/"
IMAGE="voidedtech-"
UPDATE="update-toolbox"
BUILD="build-toolbox"
GOTOOLS="go-tooling"
ALL="update-all"
CMDS="$UPDATE $BUILD $ALL $GOTOOLS"
if [ -z "$1" ]; then
  echo "command required"
  exit 1
fi

_toolboxes() {
  for TB in $(toolbox list -c | tail -n +2 | awk '{print $2}'); do
    echo "updating: $TB"
    if ! toolbox run -c "$TB" sudo dnf update -y; then
      echo "update failed"
      exit 1
    fi
  done 
}

_gotooling() {
  if ! toolbox run -c "go" fish -c "gotooling"; then
    echo "failed to update go tooling"
    exit 1
  fi
}

_buildimage() {
  echo "building image: $1"
  if ! (cd "$SOURCES" && podman build -f "$2" -t "$IMAGE$1"); then
    echo "failed"
    exit 1
  fi
}

case "$1" in
  "$BUILD")
    _buildimage "toolbox" "toolbox.Containerfile"
    for FILE in "$SOURCES"*.Containerfile; do
      if echo "$FILE" | grep -q '/toolbox.*'; then
        continue
      fi
      TBBASE="$(basename "$FILE")"
      TBNAME="$(echo "$TBBASE" | cut -d "." -f 1)"
      _buildimage "$TBNAME" "$TBBASE"
      echo "making toolbox: $TBNAME"
      if toolbox list -c | tail -n +2 | awk '{print $2}' | grep -q "^$TBNAME\$"; then
        echo "  -> already exists..."
        continue
      fi
      if ! toolbox create --image "$IMAGE$TBNAME" "$TBNAME"; then
        echo "failed"
        exit 1
      fi
    done
    ;;
  "$UPDATE")
    _toolboxes
    ;;
  "$GOTOOLS")
    _gotooling
    ;;
  "$ALL")
    if ! neovim-plugins; then
      exit 1
    fi
    _toolboxes
    _gotooling
    ;;
  "fish")
    cat << EOF
complete -c manage-system -f
complete -c manage-system -n "not __fish_seen_subcommand_from $CMDS" -a "$CMDS"
EOF
    ;;
  *)
    echo "unknown command: $1"
    exit 1
    ;;
esac

