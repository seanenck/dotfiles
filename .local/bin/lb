#!/usr/bin/env bash
CONFIG="$HOME/.config/lb.env"
SCRIPT="lb"
TOTP_CMD="totp"
SHOW_CMD="show"
CLIP_CMD="clip"
PB_CMD="clipboard"
TOTP_TYPE="/totp$"

if [ -s "$CONFIG" ]; then
  source "$CONFIG"
fi
if [ -z "$LB_STORE" ] || [ -z "$LB_KEY" ] || [ -z "$LB_KEYFILE" ] || [ -z "$LB_APP" ] || [ -z "$LB_CLEAR_CLIP" ]; then
  echo "missing required variables, $CONFIG setup?"
  exit 1
fi

_clear-clipboard() {
  local content counter
  content=""
  counter=0

  while true; do
    content=$(pbpaste)
    content=$(printf "$content" | shasum | cut -d " " -f 1)
    if [ "$content" != "$1" ]; then
      exit 0
    else
      if [ "$counter" -eq "$LB_CLEAR_CLIP" ]; then 
        pbcopy < /dev/null
        exit 0
      fi
    fi
    counter=$((counter+1))
    sleep 1
  done
}

_keepass-cmd() {
  echo $($LB_KEY) | "$LB_APP" "$1" --quiet --key-file "$LB_KEYFILE" "$LB_STORE" ${@:2}
}

_conv() {
  if [ -z "$1" ]; then
    echo "no file to conv" 1>&2 
    exit 1
  fi
  export LB_STORE="$1"
  _keepass-cmd export --format csv | python3 -c "
import csv
import json
import sys
import hashlib

data = sys.stdin.readlines()
reader = csv.DictReader(data)
keys = {}
for r in reader:
  result = {}
  entry = ''
  for item in ['Group', 'Title', 'Username']:
    value = r[item]
    if len(value) == 0:
      continue
    if len(entry) > 0:
      entry = entry + '/'
    entry += value
  h = hashlib.sha256()
  for item in ['Password', 'TOTP', 'Notes']:
    h.update(r[item].encode())
  keys[entry] = {'modtime': r['Last Modified'], 'hash': h.hexdigest()[0:7]}
for k in sorted(keys.keys()):
  print('{}: {{'.format(k))
  obj = keys[k]
  for i in sorted(obj.keys()):
    print('  {}: {}'.format(i, obj[i]))
  print('}')
"
}

_ls() {
  _keepass-cmd "ls" -R -f | grep -v '/$' | sort
}

_check-args() {
  if [ -n "$1" ]; then
    echo "invalid command, too many args"
    exit 1
  fi
}

_get() {
  local allowed attr val show totp
  if [ -z "$2" ]; then
    echo "entry required"
    exit 1
  fi
  totp=""
  if [ "$3" == "$TOTP_CMD" ]; then
    totp="--totp"
  fi
  allowed="Password"
  show=0
  if [ "$1" == "$SHOW_CMD" ]; then
    show=1
    allowed="$allowed Notes"
  fi
  for attr in $allowed; do
    val=$(_keepass-cmd "show" --show-protected $totp --attributes "$attr" "$2" 2>/dev/null)
    if [ -n "$val" ]; then
      echo "$val"
      return
    fi
  done
  if [ -z "$val" ]; then
    echo "unable to find entry: $2" 1>&2
    exit 1
  fi
}

_output() {
  local hash
  if [ "$1" == "$SHOW_CMD" ]; then
    echo "$2"
    return
  fi
  echo "clipboard will clear in $LB_CLEAR_CLIP (seconds)"
  printf "$2" | pbcopy
  hash=$(printf "$2" | shasum | cut -d " " -f 1)
  "$SCRIPT" "$PB_CMD" "$hash" &
  disown
}

_showclip() {
  local val
  val=$(_get "$1" "$2")
  if echo "$2" | grep -q "$TOTP_TYPE"; then
    echo "invalid entry, is totp"
    exit 1
  fi
  _output "$1" "$val"
}

_totp() {
  local val ts time seconds expires
  time=$(date +"%H:%M:%S")
  val=$(_get "$1" "$2" "$TOTP_CMD" | grep '^[0-9][0-9][0-9][0-9][0-9][0-9]$')
  if echo "$2" | grep -q -v "$TOTP_TYPE"; then
    echo "invalid entry, is not totp"
    exit 1
  fi
  if [ -z "$val" ]; then
    echo "invalid totp entry found (no match)"
    exit 1
  fi
  _output "$1" "$val"
  seconds=$(echo "$time" | cut -d ":" -f 3 | sed 's/^0//g')
  seconds=$((59-seconds))
  expires="\033[0;31mexpiring\033[0m"
  if [ "$seconds" -gt 5 ]; then
    if [ "$seconds" -lt 30 ] || [ "$seconds" -gt 35 ]; then
      expires="valid to"
    fi
  fi
  if [ "$seconds" -lt 10 ]; then
    seconds="0$seconds"
  fi

  echo
  echo -e "$expires: $time ($seconds seconds)"
}

_init() {
  local d h
  if [ -z "$LB_GIT_SYNC" ]; then
    return
  fi
  d=$(dirname "$LB_STORE")
  h="$d/.git/hooks/post-commit"
  {
    echo "#!/bin/sh"
    echo rsync $LB_STORE $LB_GIT_SYNC
  } > "$h"
  if [ ! -s "$h" ]; then
    echo "failed to set hook?"
    exit 1
  fi
  if ! chmod 755 "$h"; then
    echo "invalid hook configuration?"
    exit 1
  fi
}

if [ -z "$1" ]; then
  echo "command required"
  exit 1
fi

IS_TOTP=0
case "$1" in
  "init")
    _check-args "$2"
    _init
    ;;
  "conv")
    _check-args "$3"
    _conv "$2"
    ;;
  "$PB_CMD")
    _check-args "$3"
    if [ -n "$2" ]; then
      _clear-clipboard "$2"
    fi
    ;;
  "ls")
    _check-args "$2"
    _ls | grep -v "$TOTP_TYPE"
    ;;
  "$SHOW_CMD" | "$CLIP_CMD")
    _check-args "$3"
    _showclip "$1" "$2"
    ;;
  "$TOTP_CMD")
    IS_TOTP=1
    ;;
  *)
    echo "unknown command"
    exit 1
esac

if [ "$IS_TOTP" -eq 0 ]; then
  exit 0
fi

SUB="$2"
case "$2" in
  "ls")
    _check-args "$3"
    _ls | grep "$TOTP_TYPE"
    ;;
  "$SHOW_CMD" | "$CLIP_CMD")
    _check-args "$4"
    _totp "$2" "$3"
    ;;
  *)
    echo "unknown totp command"
    exit 1
esac
