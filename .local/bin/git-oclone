#!/usr/bin/env bash
CACHE="$HOME/.local/state/oclone.hst"
if [ ! -e "$CACHE" ]; then
  mkdir -p "$(dirname "$CACHE")"
  touch "$CACHE"
fi
if [ -z "$1" ]; then
  echo "argument required"
  exit 1
fi

_targets() {
  git config --list | grep insteadof | rev | cut -d "=" -f 1 | rev | sort -u
}

case "$1" in
  "--list")
  {
    _targets | sed 's#^localhost/##g'
    cat "$CACHE"
  } | sed 's#:#/#' | sort
  exit 0
  ;;
esac

_redirect() {
  local r base
  name=$(echo "$1" | sed 's#/#:#')
  for r in $(_targets | grep '^localhost/'); do
    base="$(basename "$r" | sed 's#:$#/#g')"
    if echo "$1" | grep -q "^$base"; then
      echo "localhost/$name"
      return
    fi
  done
  echo "$name"
}

TARGET=$(_redirect "$1")
if ! git clone "$TARGET"; then
  exit 1
fi
echo "$TARGET" >> "$CACHE"
sort -u -o "$CACHE" "$CACHE"
