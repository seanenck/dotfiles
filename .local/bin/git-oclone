#!/usr/bin/env bash
CACHE="$HOME/.local/state/oclone.hst"
REPOS="$HOME/Active/git"
if [ ! -e "$CACHE" ]; then
  mkdir -p "$(dirname "$CACHE")"
  touch "$CACHE"
fi
if [ -z "$1" ]; then
  echo "argument required"
  exit 1
fi

_targets() {
  git config --list | grep insteadof | rev | cut -d "=" -f 1 | rev | grep -v '^localhost:$' | sort -u
}

_dirs() {
  ls "$REPOS" | sed 's#$#/#g'
}

case "$1" in
  "--list")
  {
    _targets
    _dirs
    cat "$CACHE"
  } | sed 's#:#/#' | sort
  exit 0
  ;;
esac

_redirect() {
  local r base name
  for r in $(_dirs); do
    if echo "$1" | grep -q "^$r"; then
      echo "localhost:$1"
      return
    fi
  done
  echo "$1" | sed 's#/#:#'
  echo "$name"
}

TARGET=$(_redirect "$1")
if ! git clone "$TARGET"; then
  exit 1
fi
echo "$TARGET" >> "$CACHE"
sort -u -o "$CACHE" "$CACHE"
