#!/usr/bin/env bash
CACHE="$HOME/.local/state/oclone.hst"
if [ ! -e "$CACHE" ]; then
  mkdir -p "$(dirname "$CACHE")"
  touch "$CACHE"
fi
if [ -z "$1" ]; then
  echo "argument required"
  exit 1
fi

_targets() {
  git config --list | grep insteadof | rev | cut -d "=" -f 1 | rev | sort -u
}

case "$1" in
  "--list")
  {
    _targets
    cat "$CACHE"
  } | sed 's#:#/#' | sort
  exit 0
  ;;
esac

TARGET="$(echo "$1" | sed 's#/#:#')"
if ! git clone "$TARGET"; then
  exit 1
fi
echo "$TARGET" >> "$CACHE"
sort -u -o "$CACHE" "$CACHE"
# hash: 040a08e
