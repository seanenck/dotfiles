#!/bin/sh
for FILE in $(ls); do
  TARGET=$(date +%d.T_%H%M%S).$(echo "$FILE" | shasum -a 256 | cut -c 1-7)
  EXT=$(echo "$FILE" | tr '[:upper:]' '[:lower:]' | rev | cut -d "." -f 1 | rev)
  case "$EXT" in
    "heic")
      OUTPUT="$TARGET.jpeg"
      if ! sips --setProperty format jpeg --out "$OUTPUT" "$FILE"; then
        echo "failed to convert target"
        exit 1
      fi
      ;;
    "jpeg" | "jpg" | "png")
      OUTPUT="$TARGET.$EXT"
      if ! mv "$FILE" "$OUTPUT"; then
        echo "failed to rename"
      fi
      ;;
    "mov")
      OUTPUT="$TARGET.mov"
      if ! mv "$FILE" "$OUTPUT"; then
        echo "failed to transcode via avconvert"
        exit 1
      fi
      ;;
    *)
      continue
      ;;
  esac
  echo "processed: $FILE"
  if [ -n "$OUTPUT" ]; then
    rm -f "$FILE"
  fi
done
