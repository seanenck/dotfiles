#!/usr/bin/env bash
BIN=$PWD/bin
CACHE=$HOME/.cache/qmk
mkdir -p $BIN
rm $BIN/keymap.bin
FIRMWARE=$CACHE/qmk_firmware
if [ ! -d $FIRMWARE ]; then
    git clone --recurse-submodules "https://github.com/qmk/qmk_firmware/" $FIRMWARE
fi
git -C $FIRMWARE pull
current=$(git -C $FIRMWARE log -n 1 --format="%h")
hashed=$CACHE/git.last
sync=1
if [ -d $BIN/qmk_firmware ]; then
    if [ -e $hashed ]; then
        if diff <(echo $current) $hashed; then
            sync=0
        fi
    fi
fi
if [ $sync -eq 1 ]; then
    rsync -avc -delete-after $FIRMWARE $BIN
fi
echo "$current" > $hashed
podman build -f Containerfile -t qmkcli
podman run --rm --volume $BIN:/opt qmkcli cp /src/personal.hex /opt/keymap.bin
