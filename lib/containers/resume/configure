#!/usr/bin/env bash
if [ -z "$HOME_ADDRESS" ]; then
    echo "please set address"
    exit 1
fi
if [ -z "$HOME_PHONE" ]; then
    echo "please set phone"
    exit 1
fi
if [ -z "$HOME_EMAIL" ]; then
    echo "please set email"
    exit 1
fi

BIN=$PWD/bin
_clean() {
    rm -f $BIN/*.patch $BIN/*.resume
}

SCRIPT="$BIN/make.resume"
RESUME="bin/resume.pdf"
mkdir -p $BIN
_clean
cp $HOME/.env/local/lib/work/resume.patch $BIN/work.patch
{
    echo "#!/bin/sh"
    echo "make ADDRESS=\"$HOME_ADDRESS\" PHONE=\"$HOME_PHONE\" EMAIL=\"$HOME_EMAIL\""
    echo "test -s $RESUME || exit 1"
    echo "if ! mv $RESUME /opt/\$1.pdf; then"
    echo "    exit 1"
    echo "fi"
    echo "exit 0"
} > $SCRIPT

chmod 755 $SCRIPT
COMMIT=$(git ls-remote https://github.com/enckse/resume | grep HEAD | awk '{print $1}')
echo "Using commit: $COMMIT"

podman build --volume $BIN:/opt --build-arg=COMMIT="$COMMIT" -f Containerfile -t resume
_clean
