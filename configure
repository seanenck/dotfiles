#!/usr/bin/env bash
if [ ! -d ".git" ]; then
  echo "not a git directory"
  exit 1
fi

_files() {
  git ls-files
  git ls-files --others
}

_lsfiles() {
  local file dir
  for file in $(_files | grep "^$1\."); do
    if [ "$file" == ".gitignore" ]; then
      continue
    fi
    dest="$(echo "$file" | sed "s#^$1##g")"
    dir="$(dirname "$dest")"
    if [ "$dir" != "." ]; then
      echo "mkdir -p \"$HOME/$(dirname "$dest")\""
    fi
    echo "ln -sf \"$PWD/$file\" \"$HOME/$dest\""
  done
}

_makefile() {
  echo "all:"
  {
    {
      echo "mkdir -p \"$HOME/.cache\""
      _lsfiles ""
      if [ -x "configure.local" ]; then
        if ! ./configure.local; then
          printf "failed in configure.local\n" 1>&2
          exit 1
        fi
      fi
    } | awk '!x[$0]++'
    echo "rm Makefile"
  } | sed 's/^/\t/g'
}

_makefile > Makefile
