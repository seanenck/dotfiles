#!/usr/bin/env bash
if [ ! -d ".git" ]; then
  echo "not a git directory"
  exit 1
fi

_files() {
  git ls-files
  git ls-files --others
}

_lsfiles() {
  local file dir
  for file in $(_files | grep "^$1\."); do
    if [ "$file" == ".gitignore" ]; then
      continue
    fi
    dest="$(echo "$file" | sed "s#^$1##g")"
    dir="$(dirname "$file")"
    if [ "$dir" != "." ]; then
      echo "mkdir -p \"$HOME/$(dirname "$dest")\""
    fi
    echo "ln -sf \"$PWD/$file\" \"$HOME/$dest\""
  done
}

UNAME=$(uname | tr '[:upper:]' '[:lower:]')
_makefile() {
  echo "all:"
  {
    {
      if [ "$UNAME" == "linux" ]; then
        echo "mkdir -p \"$HOME/.cache\""
      fi
      _lsfiles ""
      _lsfiles "$UNAME/"
    } | sort -u -k 3
  } | sed 's/^/\t/g'
}

_makefile > Makefile
