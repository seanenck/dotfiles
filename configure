#!/usr/bin/env bash
if [ ! -d ".git" ]; then
  echo "not a git directory"
  exit 1
fi

_files() {
  git ls-files
  git ls-files --others
}

_lsfiles() {
  local file dir
  for file in $(_files | grep "^$1\."); do
    if [ "$file" == ".gitignore" ]; then
      continue
    fi
    dest="$(echo "$file" | sed "s#^$1##g")"
    dir="$(dirname "$dest")"
    if [ "$dir" != "." ]; then
      echo "mkdir -p \"$HOME/$(dirname "$dest")\""
    fi
    echo "ln -sf \"$PWD/$file\" \"$HOME/$dest\""
  done
}

_builds() {
  if [ ! -d src ]; then
    return
  fi
  if ! (cd src && make 1>&2); then
    echo "build failed: $d"
    return
  fi
}

_installs() {
  local f
  if [ ! -d src ]; then
    return
  fi
  for f in $(find src/ -type f -wholename "*/bin/*"); do
    echo "install -Dm755 $f $HOME/.local/bin/$(basename $f)"
  done
}

_makefile() {
  _builds
  echo "all:"
  {
    {
      _lsfiles ""
      if [ -x "configure.local" ]; then
        if ! ./configure.local; then
          printf "failed in configure.local\n" 1>&2
          exit 1
        fi
      fi
    } | awk '!x[$0]++'
    _installs
    echo "rm Makefile"
  } | sed 's/^/\t/g'
}

_makefile > Makefile
