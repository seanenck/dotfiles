pkgname=omnisharp-roslyn
pkgver=1.39.7
pkgrel=1
pkgdesc="OmniSharp server (STDIO) based on Roslyn workspaces"
arch='aarch64'
url="https://github.com/OmniSharp/omnisharp-roslyn"
license='MIT'
depends='dotnet7-sdk'
source="$pkgname-$pkgver.tar.gz::https://github.com/OmniSharp/$pkgname/archive/refs/tags/v$pkgver.tar.gz
        https://github.com/OmniSharp/$pkgname/commit/87b61078e86230cac3fca6e64d894ee092776a1c.patch"
options="!check chmod-clean net"

prepare() {
  cd "$srcdir/$pkgname-$pkgver"

  for f in ../*.patch; do
      patch --forward --strip=1 --input "$f"
  done

  # normally the build sets the version from git, we don't have a git repo so
  # just override it manually
  sed -i "s/0.0.1-local/$pkgver/" scripts/common.cake
  sed -i "s/0.0.1.0/${pkgver%.*}.0.0/" scripts/common.cake

  # only built STDIO
  sed -i 's/"OmniSharp.Stdio.Driver",/"OmniSharp.Stdio.Driver"/;/OmniSharp.Http.Driver/d' build.json

  # don't set RuntimeFrameworkVersion, just build against the version we are using
  # this is needed since otherwise we will use a crossgen compiler version built
  # against an older .NET 6 that does not have OpenSSL 3 support
  sed -i '/RuntimeFrameworkVersion/d;' build.cake
  sed -i '/RuntimeFrameworkVersion/d;' src/OmniSharp.Stdio.Driver/OmniSharp.Stdio.Driver.csproj

  # use arch-packaged .NET version rather than forcing this version
  rm global.json

  # use absolute path to global dotnet exe
  sed -i "s|? \"dotnet\"|? \"$(command -v dotnet)\"|" scripts/common.cake

  export DOTNET_NOLOGO=1

  dotnet tool restore
}

build() {
  cd "$srcdir/$pkgname-$pkgver"
  dotnet cake --target PublishNet6Builds --configuration Release --exclusive --use-global-dotnet-sdk
}

package() {
  install -d "$pkgdir/usr/lib"
  cp -a "$srcdir/$pkgname-$pkgver/artifacts/publish/OmniSharp.Stdio.Driver/linux-musl-arm64/net6.0" "$pkgdir/usr/lib/$pkgname"

  install -d "$pkgdir/usr/share/licenses/$pkgname"
  mv "$pkgdir/usr/lib/$pkgname/license.md" "$pkgdir/usr/share/licenses/$pkgname"

  install -d "$pkgdir/usr/bin"
  ln -s "../lib/$pkgname/OmniSharp" "$pkgdir/usr/bin/OmniSharp"
  # for compat
  ln -s "../lib/$pkgname/OmniSharp" "$pkgdir/usr/bin/omnisharp"
}

sha512sums="
dd265c24cfd666ea50f935637ba5463a51512f215913db35350d644f1ed809d3f2a809803b1f95ecbdf0dddbadd702796f5e4278b6e601f254a11e7f4d77480e  omnisharp-roslyn-1.39.7.tar.gz
0fe08f9b004ee12276e97bf3546ec048a510cd3a191aa7d1a2d6d336bf706549ffed6f0d9e6f0b2a15af9d77054015e1124bd581bb45941be6a02cf02211e902  87b61078e86230cac3fca6e64d894ee092776a1c.patch
"
