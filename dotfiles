#!/bin/bash
_install() {
  echo ".config/blap/config.yaml"
  echo ".config/shellrc/"
  case $(uname) in
    "Linux")
      echo ".justfile"
      echo ".bash_aliases"
      echo ".bashrc"
      echo ".bash_profile"
      echo ".config/bat/"
      echo ".config/git/"
      echo ".config/nvim/"
      echo ".config/user-dirs.dirs"
      echo ".config/blap/src/blap.yaml"
      echo ".config/blap/src/gittools.yaml"
      echo ".config/blap/src/lb.yaml"
      echo ".config/blap/src/gofumpt.yaml"
      echo ".config/blap/src/gopls.yaml"
      echo ".config/blap/src/revive.yaml"
      echo ".config/blap/src/staticcheck.yaml"
      echo ".config/blap/bin/go.yaml"
      echo ".config/blap/bin/just.yaml"
      echo ".config/blap/apps/nvimplugins.yaml"
      echo ".config/blap/apps/rclone.yaml"
      echo ".config/blap/apps/alpine.yaml"
      echo ".config/blap/apps/alpinevirt.yaml"
      echo ".ssh/"
      if [ -n "$DESKTOP_SESSION" ] && [ "$DESKTOP_SESSION" = "sway" ]; then
        echo ".config/waybar/"
        echo ".config/rofi/"
        echo ".config/sway/"
      fi
      ;;
    "Darwin")
      echo ".zshrc"
      echo ".gitconfig"
      echo ".config/blap/apps/rectangle.yaml"
      echo ".config/blap/apps/kitty.yaml"
      echo ".config/blap/apps/utm.yaml"
      echo ".config/blap/bin/gittools.yaml"
      echo ".config/blap/bin/lb.yaml"
      echo ".config/blap/bin/blap.yaml"
  esac
  if [ -n "$TERMINAL_EMULATOR" ]; then
    echo ".config/$TERMINAL_EMULATOR/"
  fi
}

DRYRUN=""
CHECK=0
if [ -n "$1" ]; then
  case "$1" in
    "--dry-run")
      DRYRUN="echo"
      ;;
    "--check")
      CHECK=1
      ;;
    *)
      echo "unknown command: $1"
      exit 1
      ;;
  esac
fi

DIR=""
SET=""
FILE=""
for SET in $(_install | sort -u); do
  for FILE in $(find $SET -type f); do
    if [ "$CHECK" -eq 1 ]; then
      if ! test -L "$HOME/$FILE"; then
        echo "non-link dotfile: $FILE"
      fi
      continue
    fi
    DIR=$(dirname "$FILE")
    if [ "$DIR" != "." ]; then
      $DRYRUN mkdir -p "$HOME/$DIR"
    fi
    $DRYRUN ln -sf "$PWD/$FILE" "$HOME/$FILE"
  done
done

unset SET FILE DRYRUN CHECK
