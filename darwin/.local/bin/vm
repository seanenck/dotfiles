#!/bin/sh
CONFIGS="$HOME/.config/vm"
SCREEN="vfu-vm"
PORT=9999

if [ -z "$1" ]; then
  echo "command required"
  exit 1
fi

if [ "$1" = "run" ]; then
  for OPT in $(ls "$CONFIGS" | grep json); do
    if [ -e "$CONFIGS/$(echo "$OPT" | cut -d "." -f 1)".img ]; then
      echo "starting: $OPT"
      DIR="$HOME/.workdir/host"
      if [ ! -d "$DIR" ]; then
        DIR="$HOME/Active"
      fi
      DIR="$DIR/shared"
      if [ ! -d "$DIR" ]; then
        echo "unable to find package store"
        exit 1
      fi
      CACHE="$DIR/cache"
      mkdir -p "$CACHE"
      (
        if curl --silent "http://localhost:$PORT" > /dev/null; then
          echo "http server running..."
        else
          (
            while : ; do
              date +%s > "$CACHE/now.tmpfile"
              sleep 30
            done
          ) &
          (cd "$DIR" && python3 -m http.server $PORT) &
        fi
      ) &
      exec vfu --config "$HOME/.config/vm/$OPT"
    fi
  done
  echo "no valid vms found..."
  exit 1
fi

if screen -list | grep -q "$SCREEN"; then
  if [ "$1" = "status" ]; then
    echo running
  fi
  exit 0
fi

case "$1" in
  "status")
    echo stopped
    exit 0
    ;;
  "start")
    screen -d -S "$SCREEN" -m vm run
    exit 0
    ;;
  *)
    echo "unknown command"
    exit 1
    ;;
esac
