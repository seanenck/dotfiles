#!/bin/sh
CONFIGS="$HOME/.config/vm"
SCREEN="vfu-vm"

if [ -z "$1" ]; then
  echo "command required"
  exit 1
fi

if [ "$1" = "run" ]; then
  for OPT in $(ls "$CONFIGS" | grep json); do
    if [ -e "$CONFIGS/$(echo "$OPT" | cut -d "." -f 1)".img ]; then
      echo "starting: $OPT"
      exec vfu --config "$HOME/.config/vm/$OPT"
    fi
  done
  echo "no valid vms found..."
  exit 1
fi

if screen -list | grep -q "$SCREEN"; then
  if [ "$1" = "status" ]; then
    echo running
  fi
  exit 0
fi

case "$1" in
  "status")
    echo stopped
    exit 0
    ;;
  "start")
    screen -d -S "$SCREEN" -m vm run
    exit 0
    ;;
  *)
    echo "unknown command"
    exit 1
    ;;
esac
