#!/usr/bin/env bash
CONTAINER_HOME=/var/home/containers
if env | grep -q "^DISTROBOX"; then
  echo "can NOT run from distrobox"
  exit 1
fi
if [ "$UID" -eq 0 ]; then
  echo 'do NOT run as root'
  exit 1
fi
if ! podman version >/dev/null; then
  echo "podman unavailable"
  exit 1
fi
REBUILD=0
if [ -n "$1" ]; then
  if [ "$1" == "build" ]; then
    REBUILD=1
  else
    echo "unknown command: $1"
    exit 1
  fi
fi
if [ "$REBUILD" -eq 1 ]; then
  for t in definitions/*; do
    if ! podman build -f "$t" -t "$(basename "$t")"; then
      echo "podman failed"
      exit 1
    fi
  done
fi
EXPORTS="$HOME/.hostrc"
echo "#!/usr/bin/env bash" > "$EXPORTS"
for t in $(ls definitions/); do
  {
    printf "#!/usr/bin/env bash\n"
    cat << EOF
workbench-$t() {
  local h
  if ! podman images | grep -q '^localhost/$t'; then
    echo "image not found/not built?"
    return
  fi
  h=$CONTAINER_HOME/$t
  if ! distrobox-list | cut -d "|" -f 2 | grep -q '$t'; then
    if ! distrobox-create --name $t --image localhost/$t --home \$h --volume $HOME/shared:\$h/shared --volume $HOME/workspace:\$h/workspace --volume $HOME/downloads:\$h/downloads; then
      echo "failed to create $t"
      return
    fi
  fi
  distrobox-enter --name $t --no-workdir
}
EOF
  } >> "$EXPORTS"
done
{
  cat include/*.sh
  echo timeskew
} >> "$EXPORTS"
echo "installing timeskew"
sudo install -Dm755 src/timeskew.sh /var/usrlocal/bin/timeskew
sudo install -Dm644 src/timeskew.service /etc/systemd/system/timeskew.service
