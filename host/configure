#!/usr/bin/env bash
CONTAINER_HOME=/var/home/containers
if env | grep -q "^DISTROBOX"; then
  echo "can NOT run from distrobox"
  exit 1
fi
if [ -z "$1" ]; then
  echo "no target given"
  exit 1
fi
FILE="$1.Containerfile"
if [ ! -s "$FILE" ]; then
  echo "no containerfile definition found"
  exit 1
fi
if ! podman build -f "$FILE" -t "$1"; then
  echo "podman failed"
  exit 1
fi
EXPORTS="$HOME/.hostrc"
echo "#!/usr/bin/env bash" > "$EXPORTS"
for t in $(ls *.Containerfile | cut -d "." -f 1); do
  {
    printf "#!/usr/bin/env bash\n"
    cat << EOF
workbench-$t() {
  local h
  if ! podman images | grep -q '^localhost/$t'; then
    echo "image not found/not built?"
    return
  fi
  h=$CONTAINER_HOME/$t
  if ! distrobox-list | cut -d "|" -f 2 | grep -q '$t'; then
    if ! distrobox-create --name $t --image localhost/$t --home \$h --volume $HOME/shared:\$h/shared --volume $HOME/workspace:\$h/workspace --volume $HOME/downloads:\$h/downloads; then
      echo "failed to create $t"
      return
    fi
  fi
  distrobox-enter --name $t --no-workdir
}
EOF
  } >> "$EXPORTS"
done
cat *.sh >> "$EXPORTS"
