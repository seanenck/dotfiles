#!/usr/bin/env bash
BIN=$(mktemp -d)
CACHE=$HOME/.cache/adv360
if [ ! -d $CACHE ]; then
    git clone https://github.com/KinesisCorporation/Adv360-Pro-ZMK $CACHE
    git -C $CACHE checkout V2.0
fi
git -C "$CACHE" pull
rsync -avc --delete-after $CACHE $BIN
PATCH=$PWD/keys.patch
TARGET=$BIN/adv360
if ! (cd $TARGET && patch -p1 < $PATCH); then
    echo "patch failed"
    exit 1
fi
if ! (cd $TARGET && make all); then
    echo "build failed"
    exit 1
fi
cp $TARGET/firmware/* $HOME/downloads/
rm -rf $BIN