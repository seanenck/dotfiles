#!/usr/bin/env bash
CONFIG="$HOME/.config/voidedtech/git.env"
test -e $CONFIG && source $CONFIG
REMOTE=$(upstream_remotes)
STORE=$(upstream_url)
if [ ! -d "$STORE" ]; then
  echo "$STORE does not exist"
  exit 1
fi
REPO="$1"
if [ -z "$REPO" ]; then
  echo "fetching mirror updates"
  for r in $(ls $STORE); do
    echo "-> $r"
    if ! git -C "$STORE/$r" fetch; then
      echo "failed"
    fi
  done
  exit 0
fi
DIR=$STORE/$(echo "$REPO" | rev | cut -d '/' -f 1 | rev)
if [ -d "$DIR" ]; then
  echo "$REPO is already mirrored"
  exit 0
fi
MAIN=$(echo "$REMOTE" | head -n 1)
if ! git clone "$MAIN$REPO" --mirror ${@:2} $DIR; then
  echo "clone failed"
  exit 1
fi
CNT=1
MIRRORS=$(echo "$REMOTE" | tail -n +2)
if [ -n "$MIRRORS" ]; then
  for MIRROR in $(echo "$MIRRORS"); do
    git -C "$DIR" remote set-url --add origin "$MIRROR$REPO"
  done
fi
RCV=$DIR/hooks/post-receive
{
  echo "#!/bin/sh"
  echo "git -C $DIR push origin --mirror"
} > $RCV
chmod 755 $RCV
