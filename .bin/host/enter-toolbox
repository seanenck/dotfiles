#!/usr/bin/env bash
CONF="$HOME/.config/voidedtech/toolbox.yml"
DEFAULTS="ripgrep bat git-delta git netcat"
BOXES=("golang:go,make"
       "rust:cargo,rust,gcc-c++"
       "shell:shellcheck,nodejs-bash-language-server"
       "rpms:rpmlint,make,rpmdevtools,mock")

if [ -z "$1" ]; then
  echo "command required"
  exit 1
fi
if [ "$1" == "--list" ]; then
  {
    for t in ${BOXES[@]}; do
      echo "$t" | cut -d ":" -f 1
    done
    toolbox list --containers | tail -n +2 | awk '{print $2}'
  } | sort -u
  exit 0
fi
if [ $(echo $1 | wc -c) -le 3 ]; then
  echo "name must be >= 3 characters"
  exit 1
fi

PKGS="$DEFAULTS"
for BOX in ${BOXES[@]}; do
  NAME=$(echo "$BOX" | cut -d ":" -f 1)
  if [[ "$1" == "$NAME" ]]; then
    for P in $(echo "$BOX" | cut -d ":" -f 2- | tr ',' '\n'); do
      PKGS="$PKGS $P"
    done
    break
  fi
done
HAS=$(toolbox list --containers | awk '{print $2}' | grep "^$1\$")
if [ -z "$HAS" ]; then
  if ! toolbox create "$1"; then
    echo "failed to create $1"
    exit 1
  fi
  if ! toolbox run --container "$1" sudo dnf install -y $PKGS; then
    echo "failed to install default packages"
    exit 1
  fi
fi
exec toolbox enter $1
