#!/usr/bin/env bash
DOTPREFIX="dotfiles"

_dotfiles_hook() {
  local h
  h="$1/$2"
  if [ ! -e "$h" ]; then
    return
  fi
  if [ ! -x "$h" ]; then
    echo "hook ($h) is not executable"
    return
  fi
  $h
}

_lsfiles() {
  {
    git ls-files
    git ls-files --others
  } | grep '^\.' | grep -v "^$DOTPREFIX"
}

dotfiles() {
  local f n
  n=$(uname | tr '[:upper:]' '[:lower:]')
  export DOTFILES_OS="$n"
  if [ ! -d "$DOTPREFIX" ]; then
    if [ ! -e "$DOTPREFIX" ]; then
      echo "not a dotfiles repository"
      return
    fi
  fi
  _dotfiles_hook "$DOTPREFIX" "pre"
  for f in $(_lsfiles); do
    d="$HOME/"$(dirname "$f")
    mkdir -p "$d"
    ln -sf "$PWD/$f" "$HOME/$f"
  done
  _dotfiles_hook "$DOTPREFIX" "post"
  if [ -d "$DOTFILES_OS" ]; then
    if ! (cd "$DOTFILES_OS" && $0); then
      exit 1
    fi
  fi
}

dotfiles
