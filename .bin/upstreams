#!/bin/bash
UPSTREAM="$HOME/.cache/upstreams/"
CONF="$HOME/.config/voidedtech/upstream.yml"
mkdir -p "$UPSTREAM"
PKGS="$1"

_externals() {
  local r n curr prev changed cnt len
  if [ ! -e "$CONF" ]; then
    echo "no $CONFIG file"
    exit 1
  fi
  changed=0
  cnt=0
  len=$(yq '.sources | length' "$CONF")
  if [ -z "$len" ] || [ "$len" -le 0 ]; then
    echo "invalid sources"
    exit 1
  fi
  while [ "$cnt" -lt "$len" ]; do
    n=$(yq ".sources[$cnt].name" "$CONF")
    r=$(yq ".sources[$cnt].url" "$CONF")
    curr="${UPSTREAM}$n"
    prev="$curr.prev"
    echo "checking: $r ($n)"
    if ! git ls-remote --tags "$r" > "$curr"; then
      echo "failed to fetch: $r"
      exit 1
    fi
    if [ -e "$prev" ]; then
      if ! diff -u "$prev" "$curr"; then
        echo "$r has changed"
        if confirm "dismiss"; then
          mv "$curr" "$prev"
        fi
      fi
    else
      mv "$curr" "$prev"
    fi
    cnt=$((cnt+1))
  done
  exit $changed
}

mkdir -p "$UPSTREAM"
if [ -n "$1" ]; then
  if [ "$1" != "check" ]; then
    echo "unknown command"
    exit 1
  fi
  CNT=$(find $UPSTREAM -type f -mtime -1 | wc -l)
  if [ $CNT -eq 0 ]; then
    exit 1
  fi
  exit 0
fi
_externals