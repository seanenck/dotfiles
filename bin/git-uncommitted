#!/usr/bin/env bash
PATHS=""
_loadpaths() {
    local option dir opt
    for option in ".env" "workspace"; do
        opt="$HOME/$option"
        if [ ! -d "$opt" ]; then
            continue
        fi
        for dir in $(find "$opt" -mindepth 1 -maxdepth 1 -type d | sort); do
            if [ ! -d "$dir/.git" ]; then
                continue
            fi
            origin=$(git -C "$dir" remote show)
            if [ -z "$origin" ]; then
                continue
            fi
            PATHS="$PATHS $dir"
        done
    done
}

_uncommitted() {
    git -C "$1" update-index -q --refresh
    git -C "$1" diff-index --name-only HEAD --
    git -C "$1" status -sb | grep ahead
    git -C "$1" ls-files --other --exclude-standard
    git -C "$1" branch --show-current | grep -v "master"
}

_loadpaths

first=1
for p in $(echo "$PATHS" | tr ' ' '\n'); do
    uncommit=$(_uncommitted "$p")
    if [ -n "$uncommit" ]; then
        if [ $first -eq 1 ]; then
            echo
            echo "uncommitted:"
        fi
        echo "  -> $p"
        first=0
    fi
done
if [ $first -ne 1 ]; then
    echo
fi
