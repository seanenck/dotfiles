#!/usr/bin/env bash
if [ -z "$KDBX_PASSWORD" ]; then
    echo "KDBX_PASSWORD must be set to the command to retrieve the password"
    exit 1
fi
if [ -z "$KDBX_DATABASE" ]; then
    echo "KDBX_DATABASE must be set to the path to a kdbx password database"
    exit 1
fi
if [ ! -e "$KDBX_DATABASE" ]; then
    echo "KDBX_DATABASE does not exist"
    exit 1
fi

DB=$KDBX_DATABASE
if [ ! -d "$(dirname $DB)/.git" ]; then
    echo "KDBX_DATABASE must be git controlled"
    exit 1
fi

CACHE=$HOME/.cache/kdbx
HASH=$CACHE/hash
PREV=$HASH.prev
LS=$CACHE/ls

if [ -z "$1" ]; then
    echo "command required"
    exit 1
fi

pass=$($KDBX_PASSWORD 2>/dev/null)
if [ -z "$pass" ]; then
    echo "no password retrieved..."
    $KDBX_PASSWORD
    exit 1
fi

_keepass() {
    echo "$pass" | keepassxc-cli $@ 2>/dev/null
}

_ls() {
    _keepass ls -R -f $1 | grep -v "Recycle Bin/" | sed 's/\r//g' | grep -v "/\$"
}

mkdir -p $CACHE
touch $HASH $PREV
git -C $(dirname $DB) log -n 1 --format=%h > $HASH
if [ ! -s "$LS" ]; then
    echo 1 > $PREV
fi
if ! diff -u $HASH $PREV > /dev/null; then
    _ls "$DB" > $LS
    mv $HASH $PREV
fi

_entry() {
    if [ -z "$1" ]; then
        echo "entry required"
        exit 1
    fi
    if ! cat $LS | grep -q "^$1\$"; then
        echo "entry not found"
        exit 1
    fi
}

_diff() {
    local entry same
    if [ ! -e "$KDBX_ORIGINAL" ]; then
        echo "KDBX_ORIGINAL not set for diffing"
        exit 1
    fi
    if [ -d $(dirname $KDBX_ORIGINAL)/.git ]; then
        git -C $(dirname $KDBX_ORIGINAL) pull > /dev/null 2>&1
    fi
    same=0
    if ! diff -u <(_ls "$KDBX_ORIGINAL") <(_ls "$KDBX_DATABASE"); then
        same=1
    fi
    for entry in $(_ls "$KDBX_DATABASE"); do
        if ! diff -u <(_show "$KDBX_ORIGINAL" "$entry") <(_show "$KDBX_DATABASE" "$entry"); then
            echo "^^^^^ different: $entry"
            echo
            same=1
        fi
    done
    exit $same
}

_show() {
    _keepass show -s "$1" "$2"
}

case "$1" in
    "ls")
        cat $LS
        ;;
    "show" | "password" | "notes" | "username")
        _entry "$2"
        opts="Password Notes"
        if [ "$1" == "show" ]; then
            _show "$DB" "$2"
        else
            _keepass show -s -a "$1" "$DB" "$2"
        fi
        ;;
    "clip")
        _entry "$2"
        _keepass clip $DB "$2" 0 -q
        ;;
    "totp")
        _entry "$2"
        _keepass show -t $DB "$2"
        ;;
    "diff")
        _diff
        ;;
    *)
        echo "unknown command: $1"
        exit 1
esac
