#!/bin/bash
CONFS=$PWD/.abuild
PACKS=/opt/packages
CACHE=$HOME/.cache/apks
NAME=stable
if [ ! -e APKBUILD ]; then
    echo "no apkbuild"
    exit 1
fi

_clean() {
    while ! doas rm -rf $CONFS; do
        continue
    done
    while ! doas chown -R enck:enck $PWD; do
        continue
    done
    while ! doas chown -R enck:enck $PACKS; do
        continue
    done
    echo "cleanup complete"
}
_clean
podman build -f $HOME/.env/dotfiles/lib/apod/buildenv.Containerfile -t $NAME
mkdir -p $CACHE $CONFS
cp -rL $HOME/.abuild $PWD
podman run -it --rm \
    -v $CONFS:$HOME/.abuild:U \
    -v $CONFS/localpkgs.rsa.pub:/etc/apk/keys/localpkgs.rsa.pub \
    -v $PWD:/apk:U \
    -v $PACKS:$HOME/packages:U \
    -v $CACHE:/etc/apk/cache \
    $NAME bash --login
_clean
