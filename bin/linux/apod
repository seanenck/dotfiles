#!/bin/bash
CONFS=$PWD/.abuild
PACKS=/opt/packages
CACHE=$HOME/.cache/apks
SRCS=$HOME/.cache/apksrc
NAME=stable
if [ ! -e APKBUILD ]; then
    echo "no apkbuild"
    exit 1
fi

_clean() {
    local c
    while ! doas rm -rf $CONFS; do
        continue
    done
    for c in $PWD $PACKS $SRCS; do
        while ! doas chown -R enck:enck $c; do
            continue
        done
    done
    echo "cleanup complete"
}
mkdir -p $CACHE $CONFS $SRCS
_clean
podman build -f $HOME/.env/dotfiles/lib/apod/buildenv.Containerfile -t $NAME
cp -rL $HOME/.abuild $PWD
podman run -it --rm \
    -v $CONFS:$HOME/.abuild:U \
    -v $CONFS/localpkgs.rsa.pub:/etc/apk/keys/localpkgs.rsa.pub \
    -v $PWD:/apk:U \
    -v $SRCS:/src:U \
    -v $PACKS:$HOME/packages:U \
    -v $CACHE:/etc/apk/cache \
    --workdir /apk \
    $NAME abuild -r
_clean
