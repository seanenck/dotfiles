#!/opt/local/bin/bash
export AUTOMATED=1
source ~/.bashrc
MUTTTMP=~/.mutt/tmp
CUR_HASH=$MUTTTMP/maildir.files
NEW_HASH=$CUR_HASH.next
mkdir -p $MUTTTMP
if [ ! -e $HOME/.mutt/etc ]; then
    ln -sf $HOME/.env/machines/workstations/mail $HOME/.mutt/etc
fi

_syncmail() {
    echo "syncing mail"
    mbsync-local
}

_hashmail() {
    find ~/.mutt/maildir -type f | sort
}

clear
COUNT=$(find $MUTTTMP/mbsync.log -mmin -5 | wc -l)
if [ $COUNT -eq 0 ]; then
    _syncmail
fi

_hashmail > $CUR_HASH
mutt
_hashmail > $NEW_HASH
diff -u $CUR_HASH $NEW_HASH
if [ $? -ne 0 ]; then
    _syncmail
fi
