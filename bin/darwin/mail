#!/bin/bash
ETC=~/.env/machines/workstations/mail/
MAIL=~/.mail/
LOGFILE=${MAIL}sync.$(date +%Y-%m-%d).log
MAILDIR=${MAIL}maildir
MAIRIX=${ETC}mairix
touch $LOGFILE

_syncnow() {
    mbsync -V -c ${ETC}mbsyncrc -a
    mairix -f ${MAIRIX}
}

_sync() {
    local dt
    dt=$(date +%Y-%m-%dT%H:%M:%S)
    echo "syncing mail..."
    _syncnow 2>&1 | sed "s/^/$dt /g" > $LOGFILE
}

_contents() {
    find ${MAIL}maildir -type f | /opt/local/bin/rg "/(cur|new|tmp)/"
}

CMD=$1
if [ ! -z "$CMD" ]; then
    case "$CMD" in
        "sync")
            _sync
            ;;
        "search")
            mairix -f $MAIRIX ${@:2}
            ;;
        *)
            echo "unknown command; $CMD"
            exit 1
    esac
    exit 0
fi

clear
CNT=$(find $LOGFILE -type f -mmin -1 | wc -l)
if [ $CNT -eq 0 ]; then
    _sync
fi
CONTENTS=${MAIL}mail.state
NEXT=$CONTENTS.delta
_contents > $CONTENTS
mutt -F ${ETC}muttrc
_contents > $NEXT
diff -u $CONTENTS $NEXT
if [ $? -ne 0 ]; then
    _sync
fi
osascript -e "quit app \"Terminal\""
