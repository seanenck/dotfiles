#!/bin/bash

ETC=~/.env/workstations/mail/
MAIL=~/.mail/
SCREEN_NAME="mail-quit"
PIDFILE=${MAIL}pidfile

if env | grep -q KITTY; then
    echo "do not run from kitty"
    exit 1
fi

_quit() {
    local pid
    sleep 1
    while : ; do
        if [ -e $PIDFILE ]; then
            pid=$(cat $PIDFILE)
            if ! ps -p "$pid" > /dev/null; then
                break 
            fi
        fi
    done
    osascript -e "quit app \"Terminal\""
}

CMD=$1
if [ -n "$CMD" ]; then
    case "$CMD" in
        "quit")
            _quit
            ;;
        *)
            echo "unknown command; $CMD"
            exit 1
    esac
    exit 0
fi

clear

echo $$ > $PIDFILE
if ! screen -list 2>&1 | grep -q $SCREEN_NAME; then
    screen -dmS "$SCREEN_NAME" bash "$0" quit
fi
mutt -F ${ETC}muttrc
find $MAIL -type f -name "*.log" -mtime +5 -delete
