#!/bin/bash
# create a Mutt.app via Automator:
# AppleScript:
# `do shell script "open /Users/enck/.env/dotfiles/bin/darwin/mail"`

ETC=~/.env/machines/workstations/mail/
MAIL=~/.mail/
LOGFILE=${MAIL}sync.$(date +%Y-%m-%d).log
MAILDIR=${MAIL}maildir
MAIRIX=${ETC}mairix

env | grep -q KITTY
if [ $? -eq 0 ]; then
    echo "do not run from kitty"
    exit 1
fi

_syncnow() {
    mbsync -V -c ${ETC}mbsyncrc -a
    mairix -f ${MAIRIX}
}

_sync() {
    local dt
    dt=$(date +%Y-%m-%dT%H:%M:%S)
    _syncnow 2>&1 | sed "s/^/$dt /g" > $LOGFILE
}

_echosync() {
    echo "syncing mail..."
    _sync
}

_contents() {
    find ${MAIL}maildir -type f | /opt/local/bin/rg "/(cur|new|tmp)/"
}

CMD=$1
if [ ! -z "$CMD" ]; then
    case "$CMD" in
        "sync")
            _sync
            ;;
        "search")
            mairix -f $MAIRIX ${@:2}
            ;;
        *)
            echo "unknown command; $CMD"
            exit 1
    esac
    exit 0
fi

clear

if [ -e $LOGFILE ]; then
    CNT=$(find $LOGFILE -type f -mmin -1 | wc -l)
else
    CNT=0
fi
if [ $CNT -eq 0 ]; then
    _echosync
fi
CONTENTS=${MAIL}mail.state
NEXT=$CONTENTS.delta
_contents > $CONTENTS
mutt -F ${ETC}muttrc
_contents > $NEXT
diff -u $CONTENTS $NEXT
if [ $? -ne 0 ]; then
    _echosync
fi
osascript -e "quit app \"Terminal\""
