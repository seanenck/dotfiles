#!/usr/bin/env bash
STARTDATE="2021-11-09"
YEAR=$(date +%Y)
MBLAZE=$HOME/.mblaze
SEQ=$MBLAZE/seq
MAIL=$HOME/.mail/
MAILDIR=${MAIL}maildir/
MAILTMP=${MAIL}mailtmp/
export PAGER=cat
mkdir -p "$MBLAZE" "$MAILTMP"

_cleanid() {
    mscan -I -f "%$1" "$2" | sed -E 's/[^[:alnum:]]+/-/g' | tr '[:upper:]' '[:lower:]' | sed 's/-$//g' | cut -c-$3
}

_process() {
    local sub id
    sub="${MAILDIR}$1"
    echo "processing: $1"
    if [ ! -d "$sub" ]; then
        echo "unable to find subdir: $1"
        return
    fi
    rm -f "$SEQ"
    find "$sub" -type f -newermt "$STARTDATE" -mtime -30 | grep -E "/(cur|new|tmp)/" | mseq -S
    if [ ! -s "$SEQ" ]; then
        echo "no messages..."
        return
    fi
    for id in $(mscan -f "%n"); do
        dt=$(_cleanid "19d" "$id" "20")
        subj=$(_cleanid "s" "$id" "50")
        msgid=$(_cleanid "s%I" "$id" "100000")
        msgid=$(echo "$msgid" | sha256sum | cut -d " " -f 1 | cut -c-7)
        target=${MAILTMP}$1/$YEAR/
        if [ ! -d "$target" ]; then
            mkdir -p "$target"
        fi
        target="$target$dt.$subj.$msgid.msg"
        if [ -e "$target" ]; then
            # IF a message was identifier the same but contents different...it's skipped
            continue
        fi
        cp "$(mscan -f "%R" "$id")" "$target"
    done
}

_run() {
    local d
    for d in $(echo "$MAIL_BACKUPS"); do
        _process "$d"
    done
    rsync -avc "$MAILTMP" center:/home/enck/store/home/archival/mail
}

_run
