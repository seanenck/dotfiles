#!/bin/sh
export TASK_DOCS="$HOME/Documents"
export TASK_CACHE="$HOME/Library/voidedtech"
export TASK_SOURCE="$HOME/Git/secrets/etc"
export GIT_SOURCES="$HOME/Active/git"
export TASK_VAR="$TASK_CACHE/var"
export TASK_REPORTS="$TASK_DOCS/synced/reporting"
export SYSIM="$TASK_VAR/sysim"
export TASK_LOGS="$TASK_VAR/logs"

mkdir -p "$TASK_VAR" "$SYSIM" "$TASK_LOGS"

if [ $(ls "$TASK_DOCS" | wc -l) -eq 0 ]; then
  echo "insufficient permissions"
  exit 1
fi

find "$TASK_LOGS" -type f -mtime +90 -delete

{
  for SCRIPT in "$HOME/Git/dotfiles/server/tasks/scripts/"*; do
    NAME=$(basename "$SCRIPT")
    echo "============"
    echo "> START: $NAME"
    echo
    if ! "$SCRIPT" 2>&1; then
      echo "[FAILURE] $NAME returned a non-zero exit code"
    fi
    echo 
    echo "> END: $NAME"
    echo "============"
  done
} | ts >> "$TASK_LOGS/$(date +%Y.%m.%d).tasks"
