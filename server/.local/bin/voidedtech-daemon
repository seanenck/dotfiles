#!/bin/sh
PIDFILE="$HOME/Library/voidedtech/var/daemon.pid"
SCREEN="voidedtech-daemon"
CMD="$1"
if [ -z "$1" ]; then
  CMD="status"
fi
case "$CMD" in
  "run" | "start" | "status")
    ;;
  *)
    echo "unknown command: $1"
    exit 1
    ;;
esac
if [ "$CMD" = "run" ]; then
  HOUR=$(date +%H)
  while : ; do
    date > "$PIDFILE"
    CURR=$(date +%H)
    if [ "$HOUR" = "$CURR" ]; then
      sleep 300
      continue
    fi
    HOUR="$CURR"
    {
      echo "last run"
      echo "==="
      date
      voidedtech-tasks 2>&1
    } > "$PIDFILE"
  done
else
  if screen -list 2>&1 | grep -q "$SCREEN"; then
    if [ -e "$PIDFILE" ]; then
      if [ "$(find "$PIDFILE" -type f -mmin +60 | wc -l)" -gt 0 ]; then
        echo "daemon started but not responding?"
      fi
    else
      echo "daemon started but no pid?"
      exit 1
    fi
    if [ "$CMD" = "status" ]; then
      echo "running"
    fi
    exit 0
  fi
  if [ "$(ls "$HOME/Documents" | wc -l)" -eq 0 ]; then
    echo "unable to access storage"
    exit 1
  fi
  if [ "$CMD" = "start" ]; then
    screen -d -S "$SCREEN" -m $0 run
  else
    echo "stopped"
  fi
fi
